const product = "BUET Admission Batch'21";
const purl = "https://asg-shop.herokuapp.com/112/init";
const appl = "https://facebook.com/aparsclassroom";
var search = document.getElementById('search');
var searchBtn = document.getElementById('searchBtn');
var result = document.getElementById('result');
searchBtn.addEventListener('click', () => {
    result.innerHTML = "<img src='https://thumbs.gfycat.com/DearWellinformedDalmatian-size_restricted.gif' width='100%'>";
    fetch('https://script.google.com/macros/s/AKfycbwvF8jbq4w7f9smhmISRNgGsm94YUeibeXEYd9zDiuYYPrNHZ28_SHw_jh9xbmJ4Z7QyQ/exec?phone=' + search.value.trim())
        .then((res) => {
            return res.json()
        })
        .then((loadedData) => {
            if (loadedData.data.Status != "enrolled") {
                fetch("https://script.google.com/macros/s/AKfycbyPQDAJHLUFYtmDmm4opWYhYN9pgPrVm8yyyNUpqfUBg21TnjAy3tnsFDqwn5Bl8L41Bg/exec?q=stat&uid=" + loadedData.data.phone + "&product=" + product)
                    .then(response => {
                        return response.json()
                    }).then(resp => {
                        if (resp.code === 200) {
                            swal({
                                title: resp.message,
                                icon: "warning",
                                button: "View Informations"
                            }).then(() => {
                                var data = resp.data;
                                result.innerHTML = `
                <h3>Purchase Information</h3>
                Invoice : ${data.Invoice}<br>
                Product : ${data.ProductName}<br>
                <br>
                Paid Amount : ${data.currency_amount} ৳ <br>
                Username : ${data.CustomerName}<br>
                <br>
                <strong>Joining ID : ${data.tran_id}</strong>
                
                <br>
                Email : ${data.value_b}<br>
                Phone No. ${data.value_c}<br>
                Timestamp : ${data.Timestamp}<br><br>
                App / Secret Group Link : <br><a href="${appl}" target="_blank">${appl}</a>
                `;
                            })
                        } else {
                            swal({
                                    title: "Your Rank #" + loadedData.data.Ranking,
                                    icon: "success",
                                    text: "কোর্সে এনরোল করতে নিচের বাটনে ক্লিক করো। তোমার পেমেন্টটি বাংলাদেশের ১ নম্বর অনলাইন পেমেন্ট গেটওয়ে প্রোভাইডার SSLCommerz এর মাধ্যমে গ্রহণ করা হবে। তাই এইখানে তোমার গোপনীয় তথ্য প্রদান করতে কোনো সমস্যা নেই।",
                                    button: "Proceed Payment"
                                })
                                .then(() => {

                                    var myHeaders = new Headers();
                                    myHeaders.append("Content-Type", "application/x-www-form-urlencoded");

                                    var urlencoded = new URLSearchParams();
                                    urlencoded.append("cus_name", loadedData.data.Name);
                                    urlencoded.append("email", loadedData.data.Email);
                                    urlencoded.append("phone", loadedData.data.phone);
                                    urlencoded.append("fb", loadedData.data.facebook);
                                    urlencoded.append("ranking", loadedData.data.Ranking);

                                    var requestOptions = {
                                        method: 'POST',
                                        headers: myHeaders,
                                        body: urlencoded,
                                        redirect: 'follow'
                                    };

                                    fetch("https://asg-shop.herokuapp.com/112/init", requestOptions)
                                        .then(response => response.text())
                                        .then(result => location.href = result)
                                        .catch(() => {
                                            swal({
                                                title: "Error",
                                                icon: "error",
                                                text: "Server Busy 😶\nPlease Try Again later",
                                                button: "Ok"
                                            }).then(() => {
                                                location.reload()
                                            })
                                        });
                                })
                        }
                    }).catch(() => {
                        swal({
                            title: "Error",
                            icon: "error",
                            text: "Server Busy 😶\nPlease Try Again later",
                            button: "Ok"
                        }).then(() => {
                            return location.reload()
                        })
                    })
            } else {
                swal({
                    title: "Already Enrolled !",
                    icon: "warning",
                    button: "OK"
                }).then(() => {
                    fetch("https://script.google.com/macros/s/AKfycbyPQDAJHLUFYtmDmm4opWYhYN9pgPrVm8yyyNUpqfUBg21TnjAy3tnsFDqwn5Bl8L41Bg/exec?q=stat&uid=" + loadedData.data.phone + "&product=" + product)
                        .then(response => {
                            return response.json()
                        }).then(resp => {

                            var data = resp.data;
                            result.innerHTML = `
                <h3>Purchase Information</h3>
                Invoice No. : ${data.Invoice}<br>
                Course Name : ${data.ProductName}<br>
                <br>
                Paid Amount : ${data.currency_amount} ৳ <br>
                Username : ${data.CustomerName}<br>
                <br>
                <strong>Joining ID : ${data.tran_id}</strong><br>
                
                <br>
                Email : ${data.value_b}<br>
                Phone No. ${data.value_c}<br>
                Timestamp : ${data.Timestamp}<br><br>
                App / Secret Group Link : <br><a href="${appl}" target="_blank">${appl}</a>
                `;
                        })
                })
            }

        })
        .catch(() => {
            swal({
                title: "Oh no..",
                icon: "error",
                text: "তোমার নাম আমাদের তালিকায় পাওয়া যায়নি! 😥\nনিচের বাটনে ক্লিক করে এক্সাম দিয়ে কোর্সে এনরোল করে ফেলো 😍",
                button: "Start Exam"
            }).then(() => {
                return location.replace('https://rebrand.ly/PhyAdmission');
            })
        })

})